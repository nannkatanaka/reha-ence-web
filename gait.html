<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10m歩行分析| Rehaence</title>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0000000000000000"
     crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* --- 共通デザインルール (assessment.htmlと統一) --- */
        body { background-color: #f8f9fa; font-family: "Helvetica Neue", Arial, sans-serif; color: #333; }
        .container { max-width: 900px; background: white; padding: 40px; margin-top: 30px; margin-bottom: 50px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        /* ヘッダー統一: ダークネイビー */
        .card-header { font-weight: bold; background-color: #2c3e50 !important; color: white !important; }
        
        /* 結果エリア統一 */
        .result-box { padding: 25px; border-radius: 6px; border: 1px solid #dee2e6; background-color: #e9ecef; margin-top: 30px; display: none; }
        
        /* ガイド・フッター統一 */
        .guide-section { background-color: #fff; padding: 20px; border-radius: 6px; border: 1px solid #e9ecef; margin-top: 30px; }
        .legal-footer { font-size: 0.8rem; color: #6c757d; background: #f8f9fa; padding: 30px; margin-top: 50px; border-top: 1px solid #dee2e6; }
        .fw-bold { font-weight: 600 !important; }

        /* Pro版独自要素 (ストップウォッチ等) */
        .result-value { font-family: 'Roboto Mono', monospace; font-size: 2rem; font-weight: 700; color: #2c3e50; }
        .unit { font-size: 0.8rem; color: #6c757d; margin-left: 5px; }
        
        .stopwatch-panel { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6;
            border-radius: 6px; 
            padding: 20px; 
            margin-top: 10px; 
            display: none; 
            text-align: center;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        .timer-display { 
            font-family: 'Roboto Mono', monospace; 
            font-size: 2.8rem; 
            font-weight: 700; 
            color: #2c3e50; 
            margin-bottom: 15px;
            letter-spacing: -1px;
        }

        /* アラートスタイル調整 */
        .alert-custom { border-left: 5px solid; background-color: #fff; }

        @media print { 
            .no-print { display: none !important; } 
            body { background-color: white; -webkit-print-color-adjust: exact; }
            .container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; }
            .result-box { background-color: #fff !important; border: 1px solid #333 !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <a href="index.html" class="text-decoration-none text-secondary small mb-2 d-inline-block no-print">
                <i class="bi bi-arrow-left"></i> ホームに戻る
            </a>
            <h2 class="fw-bold text-dark mb-0"><i class="bi bi-speedometer2"></i> 10m歩行分析</h2>
            <small class="text-muted"></small>
        </div>
        <button onclick="window.print()" class="btn btn-outline-dark btn-sm no-print"><i class="bi bi-printer"></i> レポート印刷</button>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header"><i class="bi bi-stopwatch"></i> 測定データ入力</div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <label class="small fw-bold mb-2">身長 (cm)</label>
                    <input type="number" id="height" class="form-control" placeholder="任意 (推奨)" inputmode="decimal">
                    <div class="form-text small text-muted"><i class="bi bi-info-circle"></i> 入力で「歩幅比」判定が有効化</div>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold mb-2">測定距離 (m)</label>
                    <input type="number" id="distance" class="form-control" value="10" inputmode="decimal">
                </div>
                
                <div class="col-md-6">
                    <label class="small fw-bold mb-2">所要時間 (秒)</label>
                    <div class="input-group">
                        <input type="number" id="time" class="form-control" placeholder="0.00" inputmode="decimal">
                        <button class="btn btn-outline-secondary" type="button" onclick="toggleStopwatch()"><i class="bi bi-clock"></i> 計測モード</button>
                    </div>
                    
                    <div id="stopwatch-panel" class="stopwatch-panel">
                        <div id="timer-display" class="timer-display">0.00</div>
                        <div class="d-grid gap-2 col-10 mx-auto">
                            <button type="button" class="btn btn-dark btn-lg rounded-pill" id="btn-toggle" onclick="toggleTimer()">
                                <i class="bi bi-play-fill"></i> スタート
                            </button>
                            <button type="button" class="btn btn-sm btn-link text-secondary text-decoration-none" id="btn-reset" onclick="resetTimer()">
                                <i class="bi bi-arrow-counterclockwise"></i> リセット
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block" style="font-size: 0.75rem;">ストップで自動入力されます</small>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="small fw-bold mb-2">歩数 (歩)</label>
                    <input type="number" id="steps" class="form-control" placeholder="例: 15" inputmode="numeric">
                </div>
            </div>
            
            <button class="btn btn-dark w-100 mt-4 py-3 fw-bold shadow-sm no-print" onclick="calculate()">アセスメントを実行</button>
        </div>
    </div>

    <div id="result-area" class="result-box text-center">
        <h5 class="fw-bold text-dark mb-4 border-bottom pb-2">分析結果レポート</h5>
        
        <div id="feedback-box" class="alert alert-custom mb-4 text-start shadow-sm" role="alert"></div>

        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="p-3 bg-white border rounded h-100">
                    <small class="d-block text-secondary mb-1">歩行速度</small>
                    <div class="result-value" id="res-speed-sec">0.00</div>
                    <span class="unit">m/sec</span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 bg-white border rounded h-100">
                    <small class="d-block text-secondary mb-1">歩幅 (平均)</small>
                    <div class="result-value" id="res-step-length">0.0</div>
                    <span class="unit">cm</span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 border rounded h-100" style="background-color: #f1f8ff; border-color: #cce5ff !important;">
                    <small class="d-block text-primary fw-bold mb-1">歩幅/身長比</small>
                    <div class="result-value text-primary" id="res-step-ratio">--</div>
                    <span class="unit">%</span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 bg-white border rounded h-100">
                    <small class="d-block text-secondary mb-1">ケイデンス</small>
                    <div class="result-value" id="res-cadence">0.0</div>
                    <span class="unit">歩/min</span>
                </div>
            </div>
        </div>

        <div class="bg-white p-3 rounded border text-start small text-secondary">
            <strong><i class="bi bi-gear-fill"></i> 判定基準</strong>
            <ul class="mb-0 ps-3 mt-1" style="line-height: 1.6;">
                <li><strong>速度判定:</strong> AWGS 2019基準 (1.0m/s未満でサルコペニア疑い、0.8m/s未満で運動機能低下)</li>
                <li><strong>歩幅判定:</strong> 身長比 35%未満 (または絶対値 35cm未満) ですり足リスクあり</li>
                <li><strong>小刻み歩行:</strong> 速度低下かつ高ケイデンス (>120) で検出</li>
            </ul>
        </div>
    </div>

    <footer class="legal-footer no-print">
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold mb-3"><i class="bi bi-shield-check"></i> 免責事項・データソース</h6>
                <p>本システムはスクリーニング目的の参考値であり、医学的診断ではありません。</p>
                <div class="alert alert-light border small mt-3">
                    <strong><i class="bi bi-database"></i> 参照基準:</strong>
                    <ul class="mb-0 ps-3">
                        <li>Chen LK, et al. AWGS 2019 Consensus Update on Sarcopenia.</li>
                        <li>NCGG-SGS 身体機能評価基準値 (国立長寿医療研究センター)</li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6 border-start ps-md-5 mt-4 mt-md-0">
                <h6 class="fw-bold mb-3"><i class="bi bi-info-circle"></i> 運営情報</h6>
                <ul class="list-unstyled small text-muted">
                    <li class="mb-2"><strong>運営：</strong> Rehaenceプロジェクト</li>
                    <li><a href="privacy.html" class="text-secondary">プライバシーポリシー</a></li>
                    <li><a href="index.html" class="text-secondary">ホームに戻る</a></li>
                </ul>
            </div>
        </div>
    </footer>
</div>

<script>
    /* --- ストップウォッチ機能 (One-Button) --- */
    let timerInterval;
    let startTime;
    let elapsedTime = 0;
    let isRunning = false;

    function toggleStopwatch() {
        const panel = document.getElementById('stopwatch-panel');
        panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
    }

    function toggleTimer() {
        const btn = document.getElementById('btn-toggle');
        
        if (!isRunning) {
            // スタート処理
            startTime = Date.now() - elapsedTime;
            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                document.getElementById('timer-display').innerText = (elapsedTime / 1000).toFixed(2);
            }, 10);
            
            // ボタンを「ストップ」状態に変更（赤色）
            btn.innerHTML = '<i class="bi bi-stop-fill"></i> ストップ';
            btn.className = 'btn btn-danger btn-lg rounded-pill';
            isRunning = true;
            document.getElementById('btn-reset').disabled = true;
        } else {
            // ストップ処理
            clearInterval(timerInterval);
            const finalTime = (elapsedTime / 1000).toFixed(2);
            document.getElementById('time').value = finalTime; // 自動入力
            
            // ボタンを「スタート」状態に戻す（黒色）
            btn.innerHTML = '<i class="bi bi-play-fill"></i> スタート';
            btn.className = 'btn btn-dark btn-lg rounded-pill';
            isRunning = false;
            document.getElementById('btn-reset').disabled = false;
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        elapsedTime = 0;
        isRunning = false;
        document.getElementById('timer-display').innerText = "0.00";
        document.getElementById('time').value = "";
        
        const btn = document.getElementById('btn-toggle');
        btn.innerHTML = '<i class="bi bi-play-fill"></i> スタート';
        btn.className = 'btn btn-dark btn-lg rounded-pill';
        document.getElementById('btn-reset').disabled = false;
    }

    /* --- 分析ロジック --- */
    function calculate() {
        const height = parseFloat(document.getElementById('height').value);
        const distance = parseFloat(document.getElementById('distance').value);
        const time = parseFloat(document.getElementById('time').value);
        const steps = parseFloat(document.getElementById('steps').value);

        if (!distance || !time || !steps) {
            alert("距離、時間、歩数を入力してください");
            return;
        }

        const speedSec = distance / time;
        const stepLength = (distance * 100) / steps;
        const cadence = (steps / time) * 60;
        const stepRatio = height > 0 ? (stepLength / height) * 100 : 0;

        document.getElementById('res-speed-sec').innerText = speedSec.toFixed(2);
        document.getElementById('res-step-length').innerText = stepLength.toFixed(1);
        document.getElementById('res-cadence').innerText = cadence.toFixed(1);
        document.getElementById('res-step-ratio').innerText = height > 0 ? stepRatio.toFixed(1) : "--";

        // リスク判定
        let feedbackHTML = "";
        let riskLevel = 0;

        // 速度判定 (AWGS 2019)
        if (speedSec < 0.8) {
            feedbackHTML += "<h5 class='fw-bold text-danger mb-2'><i class='bi bi-exclamation-triangle-fill'></i> 重度の身体機能低下</h5>";
            feedbackHTML += "<p class='mb-0'>歩行速度が 0.8m/s 未満です。転倒リスクが極めて高い状態です。</p>";
            riskLevel = 2;
        } else if (speedSec < 1.0) {
            feedbackHTML += "<h5 class='fw-bold text-warning text-dark mb-2'><i class='bi bi-exclamation-circle-fill'></i> サルコペニアの疑い</h5>";
            feedbackHTML += "<p class='mb-0'>歩行速度が 1.0m/s 未満です。</p>";
            riskLevel = 1;
        } else {
            feedbackHTML += "<h5 class='fw-bold text-success mb-2'><i class='bi bi-check-circle-fill'></i> 良好</h5>";
            feedbackHTML += "<p class='mb-0'>基準値(1.0m/s)以上の速度が保たれています。</p>";
        }

        // 質的評価
        let qualityIssues = [];
        if (height > 0 && stepRatio < 35) qualityIssues.push(`歩幅比低下 (${stepRatio.toFixed(1)}%)`);
        if (!height && stepLength < 35) qualityIssues.push(`歩幅低下 (${stepLength.toFixed(1)}cm)`);
        if (speedSec < 0.8 && cadence > 120) qualityIssues.push("小刻み歩行傾向");

        if (qualityIssues.length > 0) {
            feedbackHTML += "<hr class='my-3'><div class='small text-muted'><strong><i class='bi bi-search'></i> 分析メモ:</strong> " + qualityIssues.join("、") + "</div>";
        }

        const box = document.getElementById('feedback-box');
        box.className = "alert alert-custom mb-4 text-start shadow-sm"; 
        
        if (riskLevel === 2) {
            box.classList.add("alert-danger");
            box.style.borderLeftColor = "#dc3545";
        } else if (riskLevel === 1) {
            box.classList.add("alert-warning");
            box.style.borderLeftColor = "#ffc107";
        } else {
            box.classList.add("alert-success");
            box.style.borderLeftColor = "#198754";
        }
        
        box.innerHTML = feedbackHTML;

        const resultArea = document.getElementById('result-area');
        resultArea.style.display = 'block';
        resultArea.scrollIntoView({behavior: "smooth"});
    }
</script>

</body>
</html>