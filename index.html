<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>転倒リスク・身体機能評価システム | Rehaence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Helvetica Neue", Arial, sans-serif; color: #333; }
        .container { max-width: 1100px; background: white; padding: 40px; margin-top: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .card-header { font-weight: bold; background-color: #2c3e50 !important; color: white !important; }
        .result-box { padding: 20px; border-radius: 6px; border: 1px solid #dee2e6; background-color: #e9ecef; margin-bottom: 20px; }
        .guide-section { background-color: #fff; padding: 25px; border-radius: 6px; border: 1px solid #e9ecef; margin-top: 50px; }
        .developer-message { background-color: #f8f9fa; border-left: 5px solid #2c3e50; padding: 25px; margin-top: 50px; }
        .legal-footer { font-size: 0.8rem; color: #6c757d; background: #f8f9fa; padding: 30px; margin-top: 50px; border-top: 1px solid #dee2e6; }
        .fw-bold { font-weight: 600 !important; }

        @media print { 
            .no-print { display: none !important; } 
            body { background-color: white; -webkit-print-color-adjust: exact; }
            .container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; width: 100%; }
            .card, .result-box, .guide-section { border: 1px solid #ddd !important; break-inside: avoid; }
            .guide-section { display: block !important; margin-top: 20px; }
            .chart-container { height: 350px !important; }
            h2 { font-size: 1.5rem; }
            .table-result th, .table-result td { padding: 4px 8px !important; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h2 class="fw-bold text-dark mb-0"><i class="bi bi-clipboard-data"></i> 身体機能評価レポート</h2>
            <small class="text-muted">Physical Function Assessment System (Static Version)</small>
        </div>
        <button onclick="window.print()" class="btn btn-outline-dark btn-sm no-print"><i class="bi bi-printer"></i> レポート印刷</button>
    </div>

    <div class="d-flex justify-content-center mb-5 no-print bg-light p-3 rounded border">
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="viewMode" id="modeAvg" value="average" checked onchange="switchMode('average')">
            <label class="btn btn-outline-dark px-4" for="modeAvg"><i class="bi bi-people"></i> 同年代平均比較</label>
            <input type="radio" class="btn-check" name="viewMode" id="modeHist" value="history" onchange="switchMode('history')">
            <label class="btn btn-outline-dark px-4" for="modeHist"><i class="bi bi-bar-chart-line"></i> 前回比較 (推移)</label>
        </div>
    </div>

    <div class="row g-5">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header">測定データ入力</div>
                <div class="card-body">
                    <h6 class="fw-bold border-bottom pb-2 mb-3">基本情報</h6>
                    <div class="row g-2 mb-4">
                        <div class="col-6"><label class="small fw-bold">年齢</label><input type="number" id="age" class="form-control" value="40"></div>
                        <div class="col-6"><label class="small fw-bold">性別</label><select id="gender" class="form-select"><option value="female">女性</option><option value="male">男性</option></select></div>
                        <div class="col-6"><label class="small fw-bold">身長 (cm)</label><input type="number" id="height" class="form-control" value="160"></div>
                        <div class="col-6"><label class="small fw-bold">体重 (kg)</label><input type="number" id="weight" class="form-control" value="55"></div>
                    </div>
                    <h6 class="fw-bold border-bottom pb-2 mb-3">測定値</h6>
                    <table class="table table-sm align-middle small">
                        <tbody id="input-table-body"></tbody>
                    </table>
                    <button class="btn btn-dark w-100 mt-4 py-3 fw-bold shadow-sm no-print" onclick="analyze()">アセスメントを実行</button>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div id="resBox" class="result-box text-center">
                <h5 class="fw-bold text-secondary my-2">データを入力して実行してください</h5>
            </div>
            
            <div id="bmiBox" class="mb-3 fw-bold text-center text-dark"></div>
            
            <div class="chart-container" style="height: 400px; position: relative;">
                <canvas id="mainChart"></canvas>
            </div>

            <div id="detailTableArea" class="mt-4" style="display:none;">
                <h5 class="fw-bold border-bottom pb-2 mb-3"><i class="bi bi-table"></i> 詳細分析レポート</h5>
                <table class="table table-bordered table-striped table-result small align-middle text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>項目</th>
                            <th>あなたの値</th>
                            <th>同年代平均</th>
                            <th>判定</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="guide-section mt-4">
        <h4 class="fw-bold border-bottom pb-3 mb-4"><i class="bi bi-ruler"></i> 測定マニュアル</h4>
        <div class="row g-4">
            <div class="col-md-4">
                <h6 class="fw-bold text-dark border-bottom pb-2">TUG</h6>
                <p class="small text-secondary">13.5秒以上で転倒リスク増</p>
            </div>
            <div class="col-md-4">
                <h6 class="fw-bold text-dark border-bottom pb-2">下腿周径 (CC)</h6>
                <p class="small text-secondary">男性34cm/女性33cm未満でサルコペニア疑い</p>
            </div>
            <div class="col-md-4">
                <h6 class="fw-bold text-dark border-bottom pb-2">5回立ち上がり</h6>
                <p class="small text-secondary">12秒以上で機能低下</p>
            </div>
        </div>
    </div>

    <footer class="legal-footer no-print">
        <p class="text-center">© 2026 Rehaence Project. All Rights Reserved.</p>
    </footer>
</div>

<script>
    const items = [
        {id: 'grip', label: '握力', unit: 'kg', lowBetter: false}, 
        {id: 'calf', label: '下腿周径', unit: 'cm', lowBetter: false},
        {id: 'one_leg', label: '片脚立位', unit: '秒', lowBetter: false}, 
        {id: 'five_stand', label: '5回立ち', unit: '秒', lowBetter: true},
        {id: 'tug', label: 'TUG', unit: '秒', lowBetter: true}, 
        {id: 'walk', label: '10m歩行', unit: '秒', lowBetter: true}
    ];

    // 同年代平均のダミーデータ（年齢層ごとに本来は設定する）
    const averages = {
        male:   { grip: 40, calf: 35, one_leg: 30, five_stand: 7,  tug: 8,  walk: 7 },
        female: { grip: 25, calf: 33, one_leg: 25, five_stand: 8,  tug: 9,  walk: 8 }
    };

    let currentMode = 'average';
    let chartInstance = null;

    // 入力フォーム生成
    const tbody = document.getElementById('input-table-body');
    items.forEach(item => {
        tbody.innerHTML += `
            <tr>
                <td>${item.label} <span class="small text-muted">(${item.unit})</span></td>
                <td class="mode-history-col" style="display:none"><input type="number" id="prev_${item.id}" class="form-control form-control-sm" step="0.1" placeholder="前回"></td>
                <td><input type="number" id="curr_${item.id}" class="form-control form-control-sm" step="0.1" placeholder="今回"></td>
            </tr>
        `;
    });

    function switchMode(mode) {
        currentMode = mode;
        const prevInputs = document.querySelectorAll('.mode-history-col');
        prevInputs.forEach(el => el.style.display = (mode === 'average' ? 'none' : 'table-cell'));
    }

    function analyze() {
        const age = parseFloat(document.getElementById('age').value);
        const gender = document.getElementById('gender').value;
        const height = parseFloat(document.getElementById('height').value);
        const weight = parseFloat(document.getElementById('weight').value);
        
        const curr = {}; const prev = {};
        items.forEach(item => {
            const cVal = document.getElementById('curr_' + item.id).value;
            const pVal = document.getElementById('prev_' + item.id).value;
            curr[item.id] = cVal === "" ? null : parseFloat(cVal);
            prev[item.id] = pVal === "" ? null : parseFloat(pVal);
        });

        // BMI計算
        const bmi = (weight / ((height / 100) * (height / 100))).toFixed(1);
        let bmiStatus = "普通";
        if (bmi >= 25) bmiStatus = "肥満";
        else if (bmi < 18.5) bmiStatus = "低体重";

        // スコア計算ロジック（簡易版：平均との比率）
        const avgData = averages[gender];
        const tableData = items.map(item => {
            const userVal = curr[item.id];
            const avgVal = avgData[item.id];
            let score = 0;
            let status = 'avg';

            if (userVal !== null) {
                if (item.lowBetter) {
                    score = Math.max(0, 200 - (userVal / avgVal) * 100);
                    status = userVal < avgVal ? 'good' : 'caution';
                } else {
                    score = (userVal / avgVal) * 100;
                    status = userVal > avgVal ? 'good' : 'caution';
                }
            }
            return { label: item.label, userVal, avgVal, unit: item.unit, score: Math.min(140, score), status };
        });

        const res = {
            message: "分析が完了しました",
            subMessage: `${age}歳 ${gender === 'male' ? '男性' : '女性'} の身体機能評価結果です`,
            missingData: Object.values(curr).includes(null),
            bmiInfo: { value: bmi, status: bmiStatus },
            datasets: [
                {
                    label: 'あなたのスコア',
                    data: tableData.map(d => d.score),
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    tableData: tableData
                }
            ],
            tableData: tableData
        };

        updateChart(res);
        updateDetailTable(res);
    }

    function updateChart(res) {
        document.getElementById('resBox').innerHTML = `<h5 class="fw-bold text-dark mb-1">${res.message}</h5><span class="text-secondary small">${res.subMessage}</span>`;
        document.getElementById('bmiBox').innerHTML = `<span class="badge bg-light text-dark border px-3 py-2">BMI: ${res.bmiInfo.value} (${res.bmiInfo.status})</span>`;

        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'radar',
            data: { labels: items.map(i => i.label), datasets: res.datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { r: { suggestedMin: 0, suggestedMax: 140, ticks: { stepSize: 20 } } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function updateDetailTable(res) {
        const tableArea = document.getElementById('detailTableArea');
        const tbody = document.getElementById('detailTableBody');
        tbody.innerHTML = "";
        tableArea.style.display = "block";

        res.tableData.forEach(d => {
            const badge = d.status === 'good' ? 'bg-primary' : (d.status === 'caution' ? 'bg-danger' : 'bg-secondary');
            const label = d.status === 'good' ? '平均以上' : (d.status === 'caution' ? '注意' : '平均的');
            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold">${d.label}</td>
                    <td class="text-primary fw-bold">${d.userVal || '-'} ${d.unit}</td>
                    <td>${d.avgVal} ${d.unit}</td>
                    <td><span class="badge ${badge}">${label}</span></td>
                </tr>
            `;
        });
    }
</script>
</body>
</html>
